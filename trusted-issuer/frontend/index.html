<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trusted Issuer Dashboard - ZK-KYC System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        .stat-hash {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .hash-display {
            font-family: monospace;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const ISSUER_API_URL = 'http://localhost:3002';
        
        function IssuerDashboard() {
            const [issuedDIDs, setIssuedDIDs] = useState([]);
            const [merkleRoot, setMerkleRoot] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [stats, setStats] = useState({});
            
            // New DID issuance form
            const [newDID, setNewDID] = useState({
                age: '',
                name: '',
                nationality: '',
                userAddress: ''
            });
            
            useEffect(() => {
                loadDashboardData();
                const interval = setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
                return () => clearInterval(interval);
            }, []);
            
            const loadDashboardData = async () => {
                try {
                    setLoading(true);
                    
                    // Load issued DIDs
                    const didsResponse = await fetch(`${ISSUER_API_URL}/admin/issued-dids`);
                    const didsResult = await didsResponse.json();
                    if (didsResult.success) {
                        setIssuedDIDs(didsResult.data);
                    }
                    
                    // Load merkle root
                    const rootResponse = await fetch(`${ISSUER_API_URL}/merkle-root`);
                    const rootResult = await rootResponse.json();
                    if (rootResult.success) {
                        setMerkleRoot(rootResult.data.merkleRoot);
                        setStats({
                            totalLeaves: rootResult.data.totalLeaves,
                            merkleRoot: rootResult.data.merkleRoot
                        });
                    }
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    setError('Failed to load dashboard data');
                } finally {
                    setLoading(false);
                }
            };
            
            const issueDID = async (e) => {
                e.preventDefault();
                
                if (!newDID.age || !newDID.name || !newDID.nationality || !newDID.userAddress) {
                    setError('Please fill in all fields');
                    return;
                }
                
                try {
                    setLoading(true);
                    setError(null);
                    setSuccess(null);
                    
                    const response = await fetch(`${ISSUER_API_URL}/issue-did`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            age: parseInt(newDID.age),
                            name: newDID.name,
                            nationality: newDID.nationality,
                            userAddress: newDID.userAddress
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setNewDID({ age: '', name: '', nationality: '', userAddress: '' });
                        await loadDashboardData();
                        setSuccess('‚úÖ DID issued successfully! Merkle tree updated.');
                    } else {
                        setError(`Failed to issue DID: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error issuing DID:', error);
                    setError('Failed to issue DID');
                } finally {
                    setLoading(false);
                }
            };
            
            const updateBlockchain = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    setSuccess(null);
                    
                    const response = await fetch(`${ISSUER_API_URL}/update-blockchain`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setSuccess('‚úÖ Blockchain updated successfully with new merkle root!');
                    } else {
                        setError(`Failed to update blockchain: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error updating blockchain:', error);
                    setError('Failed to update blockchain');
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="container">
                    <div className="header">
                        <h1>üèõÔ∏è Trusted Issuer Dashboard</h1>
                        <p>Zero-Knowledge KYC System - Identity Verification Authority</p>
                    </div>
                    
                    {error && (
                        <div className="error">
                            <span><strong>Error:</strong> {error}</span>
                            <button onClick={() => setError(null)} style={{background: 'none', border: 'none', fontSize: '16px', cursor: 'pointer'}}>√ó</button>
                        </div>
                    )}
                    
                    {success && (
                        <div className="success">
                            {success}
                        </div>
                    )}
                    
                    {/* Statistics */}
                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>üìä Total DIDs Issued</h3>
                            <p className="stat-number">{stats.totalLeaves || 0}</p>
                        </div>
                        <div className="stat-card">
                            <h3>üå≥ Current Merkle Root</h3>
                            <p className="stat-hash">{merkleRoot ? `${merkleRoot.slice(0, 10)}...${merkleRoot.slice(-8)}` : 'Empty'}</p>
                        </div>
                        <div className="stat-card">
                            <h3>üì° System Status</h3>
                            <p className="stat-number" style={{color: '#28a745'}}>‚úÖ Online</p>
                        </div>
                    </div>
                    
                    {/* Issue New DID */}
                    <div className="card">
                        <h2>üÜî Issue New DID</h2>
                        <form onSubmit={issueDID}>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>User Address:</label>
                                    <input
                                        type="text"
                                        value={newDID.userAddress}
                                        onChange={(e) => setNewDID({...newDID, userAddress: e.target.value})}
                                        placeholder="0x..."
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Age:</label>
                                    <input
                                        type="number"
                                        value={newDID.age}
                                        onChange={(e) => setNewDID({...newDID, age: e.target.value})}
                                        min="0"
                                        max="120"
                                        placeholder="Enter age"
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Full Name:</label>
                                    <input
                                        type="text"
                                        value={newDID.name}
                                        onChange={(e) => setNewDID({...newDID, name: e.target.value})}
                                        placeholder="John Doe"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Nationality:</label>
                                    <select
                                        value={newDID.nationality}
                                        onChange={(e) => setNewDID({...newDID, nationality: e.target.value})}
                                        required
                                    >
                                        <option value="">Select nationality</option>
                                        <option value="US">United States</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="CA">Canada</option>
                                        <option value="DE">Germany</option>
                                        <option value="FR">France</option>
                                        <option value="JP">Japan</option>
                                        <option value="AU">Australia</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" disabled={loading} className="btn btn-primary">
                                {loading ? 'Issuing...' : 'Issue DID'}
                            </button>
                        </form>
                    </div>
                    
                    {/* Blockchain Update */}
                    <div className="card">
                        <h2>‚õìÔ∏è Blockchain Management</h2>
                        <p>Update the smart contract with the current merkle root to enable proof verification:</p>
                        <button 
                            onClick={updateBlockchain} 
                            disabled={loading || !merkleRoot}
                            className="btn btn-success"
                        >
                            {loading ? 'Updating...' : 'Update Blockchain'}
                        </button>
                    </div>
                    
                    {/* Issued DIDs List */}
                    <div className="card">
                        <h2>üìã Issued DIDs</h2>
                        {loading ? (
                            <p>Loading...</p>
                        ) : (
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>User Address</th>
                                            <th>DID</th>
                                            <th>Leaf Index</th>
                                            <th>Issued At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {issuedDIDs.map((did, index) => (
                                            <tr key={index}>
                                                <td>
                                                    <span className="hash-display">
                                                        {did.userAddress.slice(0, 6)}...{did.userAddress.slice(-4)}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span className="hash-display">
                                                        {did.did.slice(0, 10)}...{did.did.slice(-8)}
                                                    </span>
                                                </td>
                                                <td>{did.leafIndex}</td>
                                                <td>{new Date(did.issuedAt).toLocaleString()}</td>
                                            </tr>
                                        ))}
                                        {issuedDIDs.length === 0 && (
                                            <tr>
                                                <td colSpan="4" style={{textAlign: 'center', color: '#666'}}>
                                                    No DIDs issued yet
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<IssuerDashboard />, document.getElementById('root'));
    </script>
</body>
</html>